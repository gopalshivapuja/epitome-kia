// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CarModel {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  slug        String    @unique
  modelYear   Int       @map("model_year")
  description String?
  kiaIndiaUrl String?   @map("kia_india_url")
  lastSyncedAt DateTime? @map("last_synced_at") @db.Timestamptz
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz

  variants         Variant[]
  offers           Offer[]
  testDriveRequests TestDriveRequest[]
  serviceBookings  ServiceBooking[]
  images           CarModelImage[]

  @@index([isActive], name: "car_models_active_idx")
  @@map("car_models")
}

model Variant {
  id         String    @id @default(uuid()) @db.Uuid
  carModelId String    @map("car_model_id") @db.Uuid
  name       String
  slug       String    @unique
  trimLevel  String?   @map("trim_level")
  basePrice  Decimal?  @map("base_price") @db.Decimal(12, 2)
  sourceUrl  String?   @map("source_url")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz

  carModel       CarModel        @relation(fields: [carModelId], references: [id])
  specifications Specification[]
  offers         Offer[]
  testDriveRequests TestDriveRequest[]
  serviceBookings  ServiceBooking[]

  @@index([carModelId], name: "variants_car_model_idx")
  @@index([isActive], name: "variants_active_idx")
  @@map("variants")
}

model Specification {
  id        String    @id @default(uuid()) @db.Uuid
  variantId String    @map("variant_id") @db.Uuid
  specKey   String    @map("spec_key")
  specValue String    @map("spec_value")
  unit      String?
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz

  variant Variant @relation(fields: [variantId], references: [id])

  @@unique([variantId, specKey], name: "specifications_variant_key_unique")
  @@index([variantId], name: "specifications_variant_idx")
  @@map("specifications")
}

model Offer {
  id          String    @id @default(uuid()) @db.Uuid
  carModelId  String?   @map("car_model_id") @db.Uuid
  variantId   String?   @map("variant_id") @db.Uuid
  title       String
  slug        String    @unique
  description String?
  startAt     DateTime  @map("start_at") @db.Timestamptz
  endAt       DateTime? @map("end_at") @db.Timestamptz
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz

  carModel CarModel? @relation(fields: [carModelId], references: [id])
  variant  Variant?  @relation(fields: [variantId], references: [id])

  @@index([carModelId], name: "offers_car_model_idx")
  @@index([variantId], name: "offers_variant_idx")
  @@index([isActive], name: "offers_active_idx")
  @@map("offers")
}

model Page {
  id             String    @id @default(uuid()) @db.Uuid
  title          String
  slug           String    @unique
  content        String?
  seoTitle       String?   @map("seo_title")
  seoDescription String?   @map("seo_description")
  isPublished    Boolean   @default(false) @map("is_published")
  publishedAt    DateTime? @map("published_at") @db.Timestamptz
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz

  faqs FAQ[]

  @@index([isPublished], name: "pages_published_idx")
  @@map("pages")
}

model BlogPost {
  id          String    @id @default(uuid()) @db.Uuid
  title       String
  slug        String    @unique
  summary     String?
  content     String?
  authorName  String?   @map("author_name")
  isPublished Boolean   @default(false) @map("is_published")
  publishedAt DateTime? @map("published_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz

  @@index([isPublished], name: "blog_posts_published_idx")
  @@map("blog_posts")
}

model FAQ {
  id           String    @id @default(uuid()) @db.Uuid
  pageId       String?   @map("page_id") @db.Uuid
  question     String
  answer       String
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  page Page? @relation(fields: [pageId], references: [id])

  @@index([pageId], name: "faqs_page_idx")
  @@index([isActive], name: "faqs_active_idx")
  @@map("faqs")
}

model DealerLocation {
  id           String    @id @default(uuid()) @db.Uuid
  name         String
  slug         String    @unique
  addressLine1 String    @map("address_line1")
  addressLine2 String?   @map("address_line2")
  city         String
  state        String
  postalCode   String    @map("postal_code")
  country      String    @default("IN")
  phone        String?
  email        String?
  latitude     Decimal?  @db.Decimal(9, 6)
  longitude    Decimal?  @db.Decimal(9, 6)
  hours        String?
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  serviceBookings ServiceBooking[]
  pickupRequests  PickupRequest[]

  @@index([isActive], name: "dealer_locations_active_idx")
  @@index([city], name: "dealer_locations_city_idx")
  @@map("dealer_locations")
}

model CustomerLead {
  id               String    @id @default(uuid()) @db.Uuid
  fullName         String    @map("full_name")
  email            String?
  phone            String?
  preferredContact String?   @map("preferred_contact")
  source           String?
  notes            String?
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt        DateTime? @map("deleted_at") @db.Timestamptz

  testDriveRequests TestDriveRequest[]
  serviceBookings   ServiceBooking[]
  pickupRequests    PickupRequest[]
  chatSessions      ChatSession[]

  @@index([email], name: "customer_leads_email_idx")
  @@index([phone], name: "customer_leads_phone_idx")
  @@map("customer_leads")
}

model TestDriveRequest {
  id             String    @id @default(uuid()) @db.Uuid
  customerLeadId String    @map("customer_lead_id") @db.Uuid
  carModelId     String?   @map("car_model_id") @db.Uuid
  variantId      String?   @map("variant_id") @db.Uuid
  preferredDate  DateTime  @map("preferred_date") @db.Date
  preferredTime  String?   @map("preferred_time")
  locationNotes  String?   @map("location_notes")
  status         String    @default("pending")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz

  customerLead CustomerLead @relation(fields: [customerLeadId], references: [id])
  carModel     CarModel?    @relation(fields: [carModelId], references: [id])
  variant      Variant?     @relation(fields: [variantId], references: [id])

  @@index([customerLeadId], name: "test_drive_customer_idx")
  @@index([carModelId], name: "test_drive_model_idx")
  @@index([variantId], name: "test_drive_variant_idx")
  @@map("test_drive_requests")
}

model ServiceBooking {
  id               String    @id @default(uuid()) @db.Uuid
  customerLeadId   String    @map("customer_lead_id") @db.Uuid
  dealerLocationId String?   @map("dealer_location_id") @db.Uuid
  carModelId       String?   @map("car_model_id") @db.Uuid
  variantId        String?   @map("variant_id") @db.Uuid
  serviceDate      DateTime  @map("service_date") @db.Date
  serviceTime      String?   @map("service_time")
  serviceType      String    @map("service_type")
  notes            String?
  status           String    @default("requested")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt        DateTime? @map("deleted_at") @db.Timestamptz

  customerLead   CustomerLead    @relation(fields: [customerLeadId], references: [id])
  dealerLocation DealerLocation? @relation(fields: [dealerLocationId], references: [id])
  carModel       CarModel?       @relation(fields: [carModelId], references: [id])
  variant        Variant?        @relation(fields: [variantId], references: [id])

  @@index([customerLeadId], name: "service_booking_customer_idx")
  @@index([dealerLocationId], name: "service_booking_location_idx")
  @@map("service_bookings")
}

model PickupRequest {
  id               String    @id @default(uuid()) @db.Uuid
  customerLeadId   String    @map("customer_lead_id") @db.Uuid
  dealerLocationId String?   @map("dealer_location_id") @db.Uuid
  pickupAddress    String    @map("pickup_address")
  pickupDate       DateTime  @map("pickup_date") @db.Date
  pickupTime       String?   @map("pickup_time")
  status           String    @default("requested")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt        DateTime? @map("deleted_at") @db.Timestamptz

  customerLead   CustomerLead    @relation(fields: [customerLeadId], references: [id])
  dealerLocation DealerLocation? @relation(fields: [dealerLocationId], references: [id])

  @@index([customerLeadId], name: "pickup_requests_customer_idx")
  @@index([dealerLocationId], name: "pickup_requests_location_idx")
  @@map("pickup_requests")
}

model ChatSession {
  id             String    @id @default(uuid()) @db.Uuid
  customerLeadId String?   @map("customer_lead_id") @db.Uuid
  sessionTopic   String?   @map("session_topic")
  channel        String    @default("web")
  startedAt      DateTime  @default(now()) @map("started_at") @db.Timestamptz
  endedAt        DateTime? @map("ended_at") @db.Timestamptz
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz

  customerLead CustomerLead?  @relation(fields: [customerLeadId], references: [id])
  messages     ChatMessage[]

  @@index([customerLeadId], name: "chat_sessions_customer_idx")
  @@map("chat_sessions")
}

model ChatMessage {
  id            String    @id @default(uuid()) @db.Uuid
  chatSessionId String    @map("chat_session_id") @db.Uuid
  senderType    String    @map("sender_type")
  message       String
  metadata      Json?
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  chatSession ChatSession @relation(fields: [chatSessionId], references: [id])

  @@index([chatSessionId], name: "chat_messages_session_idx")
  @@map("chat_messages")
}

model AIContentDraft {
  id           String    @id @default(uuid()) @db.Uuid
  title        String
  slug         String    @unique
  contentType  String    @map("content_type")
  draftContent String    @map("draft_content")
  sourcePrompt String?   @map("source_prompt")
  status       String    @default("draft")
  createdBy    String?   @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  reviews AIContentReview[]

  @@index([contentType], name: "ai_content_drafts_type_idx")
  @@map("ai_content_drafts")
}

model AIContentReview {
  id           String    @id @default(uuid()) @db.Uuid
  draftId      String    @map("draft_id") @db.Uuid
  reviewerName String    @map("reviewer_name")
  reviewNotes  String?   @map("review_notes")
  status       String
  reviewedAt   DateTime  @default(now()) @map("reviewed_at") @db.Timestamptz
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  draft AIContentDraft @relation(fields: [draftId], references: [id])

  @@index([draftId], name: "ai_content_reviews_draft_idx")
  @@map("ai_content_reviews")
}

model AdminUser {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique
  passwordHash String    @map("password_hash")
  fullName     String    @map("full_name")
  role         String    @default("staff") // admin, sales_manager, service_advisor, staff
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at") @db.Timestamptz
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  @@index([email], name: "admin_users_email_idx")
  @@index([role], name: "admin_users_role_idx")
  @@map("admin_users")
}

// Document chunks for RAG (vector embeddings for AI chatbot)
model Document {
  id         String    @id @default(uuid()) @db.Uuid
  title      String    // Document/chunk title
  source     String    // "manual", "faq", "guide", "website"
  sourceUrl  String?   @map("source_url")
  modelSlug  String?   @map("model_slug") // e.g., "seltos", "sonet"
  content    String    // The actual text content
  embedding  Unsupported("vector(1536)")? // OpenAI text-embedding-3-small
  metadata   Json?     // Additional metadata (page number, section, etc.)
  chunkIndex Int       @default(0) @map("chunk_index")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz

  @@index([source], name: "documents_source_idx")
  @@index([modelSlug], name: "documents_model_idx")
  @@map("documents")
}

// Curated external articles from automotive publications
model CuratedArticle {
  id            String    @id @default(uuid()) @db.Uuid
  title         String
  source        String    // "Autocar India", "Team-BHP", "CarDekho", etc.
  sourceUrl     String    @unique @map("source_url")
  summary       String?   // AI-generated brief (2-3 sentences)
  thumbnailUrl  String?   @map("thumbnail_url")
  publishedDate DateTime? @map("published_date") @db.Date
  kiaTags       String[]  @map("kia_tags") // ["seltos", "sonet", "ev6"]
  sentiment     String    @default("positive") // "positive", "neutral"
  isApproved    Boolean   @default(false) @map("is_approved")
  approvedBy    String?   @map("approved_by")
  approvedAt    DateTime? @map("approved_at") @db.Timestamptz
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  @@index([source], name: "curated_articles_source_idx")
  @@index([isApproved], name: "curated_articles_approved_idx")
  @@index([kiaTags], name: "curated_articles_tags_idx")
  @@map("curated_articles")
}

// Customer accounts (Google OAuth or email/phone)
model Customer {
  id          String    @id @default(uuid()) @db.Uuid
  email       String    @unique
  name        String?
  phone       String?
  googleId    String?   @unique @map("google_id")
  avatarUrl   String?   @map("avatar_url")
  savedModels String[]  @map("saved_models") // Model slugs
  preferences Json?     // { budget, fuelType, transmission, etc. }
  lastLoginAt DateTime? @map("last_login_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz

  alerts         AlertSubscription[]
  configurations VehicleConfiguration[]

  @@index([email], name: "customers_email_idx")
  @@index([googleId], name: "customers_google_id_idx")
  @@map("customers")
}

// Price and availability alert subscriptions
model AlertSubscription {
  id           String    @id @default(uuid()) @db.Uuid
  email        String
  phone        String?
  modelSlug    String?   @map("model_slug") // Specific model or null for all
  alertType    String    @map("alert_type") // "price_drop", "new_offer", "availability"
  threshold    Decimal?  @db.Decimal(12, 2) // Price threshold for alerts
  isActive     Boolean   @default(true) @map("is_active")
  customerId   String?   @map("customer_id") @db.Uuid
  lastNotified DateTime? @map("last_notified") @db.Timestamptz
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  customer Customer? @relation(fields: [customerId], references: [id])

  @@index([email], name: "alert_subscriptions_email_idx")
  @@index([modelSlug], name: "alert_subscriptions_model_idx")
  @@index([alertType], name: "alert_subscriptions_type_idx")
  @@index([customerId], name: "alert_subscriptions_customer_idx")
  @@map("alert_subscriptions")
}

// Vehicle configurations (Tesla-style configurator)
model VehicleConfiguration {
  id          String    @id @default(uuid()) @db.Uuid
  modelSlug   String    @map("model_slug")
  variantId   String    @map("variant_id") @db.Uuid
  colorCode   String    @map("color_code")
  accessories String[]  // Accessory IDs
  totalPrice  Decimal   @map("total_price") @db.Decimal(12, 2)
  shareCode   String    @unique @map("share_code") // For shareable links
  customerId  String?   @map("customer_id") @db.Uuid
  expiresAt   DateTime  @map("expires_at") @db.Timestamptz // Configs expire after 30 days
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz

  customer Customer? @relation(fields: [customerId], references: [id])

  @@index([shareCode], name: "vehicle_configurations_share_code_idx")
  @@index([customerId], name: "vehicle_configurations_customer_idx")
  @@map("vehicle_configurations")
}

// Accessories for vehicle configurator
model Accessory {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?
  price       Decimal   @db.Decimal(10, 2)
  imageUrl    String?   @map("image_url")
  modelSlugs  String[]  @map("model_slugs") // Compatible models
  category    String    // "exterior", "interior", "protection", "technology"
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz

  @@index([category], name: "accessories_category_idx")
  @@index([isActive], name: "accessories_active_idx")
  @@map("accessories")
}

// Competitor models for comparison tool
model CompetitorModel {
  id           String    @id @default(uuid()) @db.Uuid
  name         String    // "Hyundai Creta"
  brand        String    // "Hyundai"
  segment      String    // "compact_suv", "subcompact_suv", "mpv"
  priceRange   String    @map("price_range") // "₹11.0 - 20.0 Lakh"
  specs        Json      // { engine, power, torque, mileage, dimensions, etc. }
  imageUrl     String?   @map("image_url")
  sourceUrl    String?   @map("source_url") // CarDekho/CarWale URL
  competesWith String[]  @map("competes_with") // ["seltos", "sonet"]
  lastUpdated  DateTime  @default(now()) @map("last_updated") @db.Timestamptz
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  @@index([brand], name: "competitor_models_brand_idx")
  @@index([segment], name: "competitor_models_segment_idx")
  @@map("competitor_models")
}

// User browsing preferences for personalization
model UserPreference {
  id           String    @id @default(uuid()) @db.Uuid
  visitorId    String    @unique @map("visitor_id") // Anonymous ID stored in cookie
  customerId   String?   @map("customer_id") @db.Uuid // Linked when logged in
  viewedModels String[]  @map("viewed_models") // Model slugs
  interests    Json?     // { budget: "15-20L", fuelType: "petrol", etc. }
  lastVisit    DateTime  @default(now()) @map("last_visit") @db.Timestamptz
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@index([visitorId], name: "user_preferences_visitor_idx")
  @@index([customerId], name: "user_preferences_customer_idx")
  @@map("user_preferences")
}

// Sync logs for Kia India content auto-sync
model SyncLog {
  id           String    @id @default(uuid()) @db.Uuid
  source       String    // "kia_india"
  modelSlug    String?   @map("model_slug")
  status       String    // "success", "failed", "partial"
  changesFound Json?     @map("changes_found") // { prices: [{...}], specs: [{...}] }
  appliedAt    DateTime? @map("applied_at") @db.Timestamptz
  error        String?
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([source], name: "sync_logs_source_idx")
  @@index([status], name: "sync_logs_status_idx")
  @@map("sync_logs")
}

// Car model images for 360° viewer and gallery
model CarModelImage {
  id         String    @id @default(uuid()) @db.Uuid
  carModelId String    @map("car_model_id") @db.Uuid
  type       String    // "exterior_360", "interior_360", "gallery", "hero"
  angle      Int?      // 0-35 for 360 images (10° increments)
  url        String
  altText    String?   @map("alt_text")
  sortOrder  Int       @default(0) @map("sort_order")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz

  carModel CarModel @relation(fields: [carModelId], references: [id])

  @@index([carModelId], name: "car_model_images_model_idx")
  @@index([type], name: "car_model_images_type_idx")
  @@map("car_model_images")
}
